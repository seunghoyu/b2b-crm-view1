<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>B2B CRM 상담현황</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-50 h-screen flex overflow-hidden">
    <!-- ✅ 좌측 사이드 메뉴 -->
    <aside class="w-[230px] bg-blue-800 text-white flex-shrink-0">
      <a href="b2b_dashboard_tailwind.html" class="block p-5 text-lg font-semibold border-b border-blue-700 hover:bg-blue-700 transition">
        B2B CRM 메뉴
      </a>

      <nav class="p-3 space-y-2">
        <!-- 문자관리 -->
        <div>
          <button
            id="menuToggle1"
            class="w-full flex justify-between items-center px-4 py-2 rounded-lg hover:bg-blue-700 transition"
          >
            <span>문자관리</span>
            <span>▼</span>
          </button>
          <div id="menu1" class="hidden ml-4 mt-2 space-y-1 text-sm">
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">문자발송</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">문자설정</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">발송이력 조회</a>
          </div>
        </div>

        <!-- 이메일 관리 -->
        <div>
          <button id="menuToggleEmail" class="w-full flex justify-between items-center px-4 py-2 rounded-lg hover:bg-blue-700 transition">
            <span>이메일 관리</span>
            <span>▼</span>
          </button>
          <div id="menuEmail" class="hidden ml-4 mt-2 space-y-1 text-sm">
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">웹메일(Biz)</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">패스메일(fnBiz)</a>
          </div>
        </div>

        <!-- 비즈톡 관리 -->
        <div>
          <button id="menuToggleBiztalk" class="w-full flex justify-between items-center px-4 py-2 rounded-lg hover:bg-blue-700 transition">
            <span>비즈톡 관리</span>
            <span>▼</span>
          </button>
          <div id="menuBiztalk" class="hidden ml-4 mt-2 space-y-1 text-sm">
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">비즈톡발송(강의)</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">비즈톡발송(회원)</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">발송이력 조회(강의)</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">발송이력 조회(회원)</a>
          </div>
        </div>

        <!-- 관리메뉴 -->
        <div>
          <button
            id="menuToggle2"
            class="w-full flex justify-between items-center px-4 py-2 rounded-lg hover:bg-blue-700 transition"
          >
            <span>관리메뉴</span>
            <span>▼</span>
          </button>
          <div id="menu2" class="ml-4 mt-2 space-y-1 text-sm">
            <a href="b2b_dashboard_tailwind.html" class="block px-3 py-1 bg-blue-900 rounded font-semibold">상담 현황</a>
            <a href="company_list.html" class="block px-3 py-1 hover:bg-blue-700 rounded">기업 목록</a>
            <a href="customer_list.html" class="block px-3 py-1 hover:bg-blue-700 rounded">고객 목록</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">수강시간 조회</a>
            <a href="#" class="block px-3 py-1 hover:bg-blue-700 rounded">학습상담·CS 관리</a>
            <a href="customer_registration.html" class="block px-3 py-1 hover:bg-blue-700 rounded">신규 고객 등록</a>
          </div>
        </div>
      </nav>
    </aside>

    <!-- ✅ 메인 영역 -->
    <div class="flex-1 flex flex-col">
      <!-- 상단 헤더 -->
      <header class="bg-blue-700 text-white py-4 shadow">
        <div class="w-full px-10 flex justify-between items-center">
          <h1 class="text-2xl font-semibold">B2B CRM 상담현황</h1>
          <span class="text-sm opacity-90">관리자용 대시보드</span>
        </div>
      </header>

      <main class="flex-1 w-full px-10 py-8 overflow-y-auto">
        <!-- 필터 영역 -->
        <section class="bg-white p-6 rounded-xl shadow mb-8 text-sm">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4 items-end">
            <!-- 1행 -->
            <div>
              <label class="font-medium text-gray-700">조회기간</label>
              <div class="flex items-center mt-1">
                <input type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none" />
                <span class="mx-2 text-gray-500">~</span>
                <input type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none" />
              </div>
            </div>
            <div>
              <label class="font-medium text-gray-700">상담구분 [대분류]</label>
              <select id="categoryMain" class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none">
                <option value="">전체</option>
                <!-- JS로 채워짐 -->
              </select>
            </div>
            <div>
              <label class="font-medium text-gray-700">상담구분 [중분류]</label>
              <select id="categorySub" class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none disabled:bg-gray-100" disabled>
                <option value="">전체</option>
                <!-- JS로 채워짐 -->
              </select>
            </div>
            <div>
              <label class="font-medium text-gray-700">처리상태</label>
              <select class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none">
                <option>전체</option>
                <option>처리대기</option>
                <option>처리완료</option>
              </select>
            </div>
            <!-- 2행: 기업명, 기업코드 -->
            <div class="md:col-span-2 relative">
              <label class="font-medium text-gray-700">기업명</label>
              <input type="text" id="company-search" placeholder="기업명을 입력하여 검색" class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none" autocomplete="off" />
              <div id="company-suggestions" class="hidden absolute z-20 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-60 overflow-y-auto">
                <!-- JS로 제안 목록 생성 -->
              </div>
              <div id="daou-notice" class="hidden text-red-600 text-xs mt-1">
                다우오피스 플랫폼 고객사의 문의가 아닌, 다우오피스 자체문의일 경우에는 대괄호 내의 회사명을 작성하지 않아도 됩니다.
              </div>
            </div>
            <div>
              <label class="font-medium text-gray-700">기업코드</label>
              <input type="text" id="company-code" placeholder="기업 선택 시 자동 입력" class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none bg-gray-100" readonly />
            </div>
            <div></div>
            <!-- 3행 -->
            <div>
              <label class="font-medium text-gray-700">회원구분</label>
              <select class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none">
                <option value="">전체</option>
                <option>기업관리자</option>
                <option>교육담당자</option>
                <option>기업운영자</option>
                <option>학습자</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="font-medium text-gray-700">담당자</label> 
              <select class="w-full mt-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-blue-400 focus:outline-none">
                <option value="">전체</option>
                <option>박지현</option>
                <option>이현우</option>
                <option>김영희</option>
                <option>이하윤</option>
              </select>
            </div>
            <button class="bg-blue-600 text-white w-full h-[42px] rounded-lg hover:bg-blue-700 transition font-semibold">
              검색
            </button> 
          </div>
        </section>

        <!-- 테이블 영역 -->
        <section class="bg-white p-6 rounded-xl shadow overflow-x-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-gray-800">상담 목록</h2>
            <div class="flex items-center space-x-4">
              <button
                onclick="window.location.href='customer_registration.html'"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-semibold"
              >고객 등록</button>
              <span id="count" class="text-sm text-gray-500"></span>
            </div>
          </div>

          <table class="w-full table-auto border-collapse text-sm text-gray-700">
            <thead>
              <tr class="bg-gray-100 border-b text-left text-gray-600">
                <th class="p-4">상담일시</th>
                <th class="p-4">기업코드</th>
                <th class="p-4">기업명</th>
                <th class="p-4">이름</th>
                <th class="p-4">회원구분</th>
                <th class="p-4">아이디</th>
                <th class="p-4">대분류</th>
                <th class="p-4">중분류</th>
                <th class="p-4">담당자</th>
                <th class="p-4">처리상태</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </section>
      </main>
    </div>

    <script>
      // ✅ 사이드메뉴 토글
      const menuToggle1 = document.getElementById("menuToggle1");
      const menu1 = document.getElementById("menu1");
      const menuToggle2 = document.getElementById("menuToggle2");
      const menu2 = document.getElementById("menu2");
      const menuToggleEmail = document.getElementById("menuToggleEmail");
      const menuEmail = document.getElementById("menuEmail");
      const menuToggleBiztalk = document.getElementById("menuToggleBiztalk");
      const menuBiztalk = document.getElementById("menuBiztalk");

      menuToggle1.addEventListener("click", () => menu1.classList.toggle("hidden"));
      menuToggle2.addEventListener("click", () => menu2.classList.toggle("hidden"));
      menuToggleEmail.addEventListener("click", () => menuEmail.classList.toggle("hidden"));
      menuToggleBiztalk.addEventListener("click", () => menuBiztalk.classList.toggle("hidden"));
      menu2.classList.remove("hidden"); // 관리메뉴는 기본으로 열어둠

      // ✅ 상담구분 [대분류] - [중분류] 연동
      const categoryMap = {
        "수강·결제": ["결제오류", "환불문의", "영수증발급", "할인문의", "결제방법"],
        "수강환경·접속": ["로그인문제", "비밀번호찾기", "계정오류", "접속불가", "브라우저문제"],
        "학습진행·평가": ["진도율문의", "시험응시", "과제제출", "수료증발급", "성적문의"],
        "강의·강사": ["강의내용", "강의자료", "강의오류", "강의요청"],
        "기타·제휴": ["제휴문의", "견적문의", "단체문의", "기타", "건의사항"]
      };

      const categoryMainSelect = document.getElementById("categoryMain");
      const categorySubSelect = document.getElementById("categorySub");

      // 대분류 옵션 채우기
      Object.keys(categoryMap).forEach(mainCat => {
        const option = document.createElement("option");
        option.value = mainCat;
        option.textContent = mainCat;
        categoryMainSelect.appendChild(option);
      });

      // 대분류 선택 시 중분류 업데이트
      categoryMainSelect.addEventListener("change", function() {
        const selectedMain = this.value;
        // 중분류 초기화
        categorySubSelect.innerHTML = '<option value="">전체</option>'; 
        
        if (selectedMain && categoryMap[selectedMain]) {
          // 선택된 대분류에 해당하는 중분류 옵션 추가
          categoryMap[selectedMain].forEach(sub => {
            const option = document.createElement("option");
            option.value = sub;
            option.textContent = sub;
            categorySubSelect.appendChild(option);
          });
          // 중분류 활성화
          categorySubSelect.disabled = false;
        } else {
          // 대분류가 '전체'일 경우 중분류 비활성화
          categorySubSelect.disabled = true;
        }
      });

      // ✅ 기업명 검색 기능 (customer_registration.html과 유사하게)
      const companyDB = [
          { name: "삼성전자", code: "samsung" }, { name: "SK하이닉스", code: "skhynix" },
          { name: "LG화학", code: "lgchem" }, { name: "현대자동차", code: "hyundai" },
          { name: "카카오", code: "kakao" }, { name: "네이버", code: "naver" },
          { name: "CJ푸드빌", code: "cjfood" }, { name: "대한항공", code: "koreanair" },
          { name: "다우오피스", code: "daou" }, { name: "포스코", code: "posco" }
      ];

      const searchInput = document.getElementById("company-search");
      const suggestionsContainer = document.getElementById("company-suggestions");
      const codeInput = document.getElementById("company-code");
      const daouNotice = document.getElementById("daou-notice");
      let highlightedIndex = -1;

      function highlightItem(index) {
          const items = suggestionsContainer.querySelectorAll("div");
          items.forEach((item, i) => {
              if (i === index) {
                  item.classList.add("bg-blue-100");
                  item.scrollIntoView({ block: 'nearest' });
              } else {
                  item.classList.remove("bg-blue-100");
              }
          });
      }

      searchInput.addEventListener("input", () => {
          const query = searchInput.value.trim();
          if (query.length === 0) {
              suggestionsContainer.classList.add("hidden");
              daouNotice.classList.add("hidden");
              searchInput.classList.remove("text-blue-600", "font-bold");
              codeInput.value = ""; // 검색어 없으면 기업코드도 비움
              return;
          }

          const filteredCompanies = companyDB.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
          
          suggestionsContainer.innerHTML = "";
          filteredCompanies.forEach(company => {
              const item = document.createElement("div");
              item.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer";
              if (company.name === "다우오피스") {
                  item.classList.add("text-blue-600", "font-bold");
              }
              item.textContent = company.name;
              item.addEventListener("click", () => {
                  codeInput.value = company.code; // 기업코드 자동 입력
                  suggestionsContainer.classList.add("hidden");

                  if (company.name === "다우오피스") {
                      searchInput.value = "다우오피스[]";
                      searchInput.classList.add("text-blue-600", "font-bold");
                      daouNotice.classList.remove("hidden");
                      // 커서를 대괄호 사이에 위치시킵니다.
                      searchInput.focus();
                      searchInput.setSelectionRange(searchInput.value.length - 1, searchInput.value.length - 1);
                  } else {
                      searchInput.value = company.name; // 선택한 기업명으로 입력창 값 변경
                      searchInput.classList.remove("text-blue-600", "font-bold");
                      daouNotice.classList.add("hidden");
                  }
              });
              suggestionsContainer.appendChild(item);
          });

          if (filteredCompanies.length > 0) {
            suggestionsContainer.classList.remove("hidden");
          } else {
            suggestionsContainer.classList.add("hidden");
          }
          highlightedIndex = -1; // 검색어 변경 시 하이라이트 초기화
      });

      searchInput.addEventListener("keydown", (e) => {
          const items = suggestionsContainer.querySelectorAll("div");
          if (suggestionsContainer.classList.contains("hidden") || items.length === 0) return;

          if (e.key === "ArrowDown") {
              e.preventDefault();
              highlightedIndex = (highlightedIndex + 1) % items.length;
              highlightItem(highlightedIndex);
          } else if (e.key === "ArrowUp") {
              e.preventDefault();
              highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
              highlightItem(highlightedIndex);
          } else if (e.key === "Enter") {
              e.preventDefault();
              if (highlightedIndex > -1) {
                  items[highlightedIndex].click();
              }
              suggestionsContainer.classList.add("hidden");
              // Enter를 누르면 검색이 되어야 하므로, 여기서는 검색창을 비우지 않습니다.
          } else if (e.key === "Escape") {
              suggestionsContainer.classList.add("hidden");
          }
      });

      // 다른 곳 클릭 시 제안 창 닫기
      document.addEventListener("click", (e) => {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
          suggestionsContainer.classList.add("hidden");
        }
      });

      // ✅ 상담목록 데이터
      // customer_list.html의 데이터 생성 로직과 유사하게 구성하여 데이터 일관성 확보
      const companies = [
          { name: "삼성전자", code: "samsung" }, { name: "SK하이닉스", code: "skhynix" },
          { name: "LG화학", code: "lgchem" }, { name: "현대자동차", code: "hyundai" },
          { name: "카카오", code: "kakao" }, { name: "네이버", code: "naver" },
          { name: "CJ푸드빌", code: "cjfood" }, { name: "대한항공", code: "koreanair" },
          { name: "다우오피스", code: "daou" }, { name: "포스코", code: "posco" }
      ];
      const memberTypes = ["기업관리자", "교육담당자", "기업운영자", "학습자"];
      const managers = ["박지현", "이현우", "김영희", "이하윤"];
      const mainCategories = ["수강·결제", "수강환경·접속", "학습진행·평가", "강의·강사", "기타·제휴"];
      const subCategories = {
        "수강·결제": ["결제오류", "환불문의", "영수증발급"],
        "수강환경·접속": ["로그인문제", "비밀번호찾기", "접속불가"],
        "학습진행·평가": ["진도율문의", "시험응시", "수료증발급"],
        "강의·강사": ["강의내용", "강의자료", "강의오류"],
        "기타·제휴": ["제휴문의", "견적문의", "기타"]
      };

      const dummyData = [];
      companies.forEach((company, companyIndex) => {
        for (let i = 0; i < 3; i++) {
            const firstNames = ["김", "이", "박", "최", "정", "강", "조", "윤", "장", "임"];
            const lastNames = ["민준", "서연", "도윤", "서윤", "시우", "지우", "하준", "지유", "주원", "서현"];
            const name = firstNames[(companyIndex + i) % firstNames.length] + lastNames[(companyIndex + i) % lastNames.length];
            const id = `${company.code}_user${i + 1}`;
            const mainCategory = mainCategories[i % mainCategories.length];

            dummyData.push({
                date: `2025-10-${String(20 - (companyIndex + i)).padStart(2, '0')} ${String(10+i).padStart(2, '0')}:${String(30+i*5).padStart(2, '0')}`,
                companyCode: company.code,
                companyName: company.name,
                name: name,
                memberType: memberTypes[i % memberTypes.length],
                id: id,
                mainCategory: mainCategory,
                subCategory: subCategories[mainCategory][i % subCategories[mainCategory].length],
                manager: managers[(companyIndex + i) % managers.length],
                status: i % 2 === 0 ? "처리완료" : "처리대기",
            });
        }
      });

      const tbody = document.getElementById("table-body");

      // ✅ 상담일시 기준으로 내림차순 정렬 (최신순)
      dummyData.sort((a, b) => new Date(b.date) - new Date(a.date));

      // 상위 15개만 표시
      dummyData.slice(0, 15).forEach((d) => {
        const row = document.createElement("tr");
        row.setAttribute("onclick", "window.location.href='customer_view.html'");
        row.className = "border-b hover:bg-blue-50 cursor-pointer transition";
        row.innerHTML = `
          <td class='p-4'>${d.date}</td>
          <td class='p-4'>${d.companyCode}</td>
          <td class='p-4 font-medium'>${d.companyName}</td>
          <td class='p-4'>${d.name}</td>
          <td class='p-4'>${d.memberType}</td>
          <td class='p-4'>${d.id}</td>
          <td class='p-4'>${d.mainCategory}</td>
          <td class='p-4'>${d.subCategory}</td>
          <td class='p-4'>${d.manager}</td>
          <td class='p-4 font-semibold ${
            d.status === "처리완료"
              ? "text-green-600"
              : d.status === "처리대기"
              ? "text-red-600"
              : "text-gray-500"
          }'>${d.status}</td>`;
        tbody.appendChild(row);
      });

      document.getElementById("count").innerText = `총 ${dummyData.slice(0, 15).length}건`;
    </script>
  </body>
</html>
  